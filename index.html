<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>Riverford Data Analytics</title>
        <link rel="stylesheet" href="css/style.css">
        <script src="js/Chart.bundle.js"></script>
        <style type="text/css">
            /* Chart.js */
            @-webkit-keyframes chartjs-render-animation {
                from {
                    opacity: 0.99
                }
                to {
                    opacity: 1
                }
            }

            @keyframes chartjs-render-animation {
                from {
                    opacity: 0.99
                }
                to {
                    opacity: 1
                }
            }

            .chartjs-render-monitor {
                -webkit-animation: chartjs-render-animation 0.001s;
                animation: chartjs-render-animation 0.001s;
            }
            
            .charts {
                min-width: 600px; 
                width: 60%;
            }
            
            .top10 {
                display: none;
            }
        </style>
    </head>
    <body>
        <h1>Riverford Data Analytics</h1>

        <!-- TODO Add HTML containers for data visualisation -->
        <div id="Summary" class="charts"><canvas id="SummaryChart"></canvas></div>
        <div id="Veg" class="charts top10"><canvas id="VegChart"></canvas></div>
        <div id="Meat" class="charts top10"><canvas id="MeatChart" class="charts"></canvas></div>
        <div id="Extras" class="charts top10"><canvas id="ExtrasChart" class="charts"></canvas></div>
        <div id="Recipeboxes" class="charts top10"><canvas id="RecipeboxesChart" class="charts"></canvas></div>
        <div id="Vegboxes" class="charts top10"><canvas id="VegboxesChart" class="charts"></canvas></div>
        <script>
            var sourceData;   
            
            // Initial data load
            fetch("data.json", {
                method: "GET",
                headers: new Headers({
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                })
            }).then(function (body) {
                return body.json();
            }).then(function (data) {
                sourceData = data;
                var labelmap = new Map();
                // TODO: Build data visualisation 

                for(var label in sourceData) {
                    arr = [];
                    for(var item in sourceData[label]) {
                        arr.push([item, sourceData[label][item]]);
                    }
                    
                    arr.sort(function(a,b) {
                        return a[1]>b[1]? -1:a[1]<b[1]? 1:0;
                    });
                    
                    var itemmap = new Map();
                    arr.forEach(function(itemval) {
                        itemmap.set(itemval[0], itemval[1]);
                    });
                    
                    labelmap.set(label, itemmap);
                }
                
                //alert(Array.from(labelmap.get("Recipe boxes")));
                //alert(Object.keys(sourceData["Veg"]));
                
                var summaryset = [];
                var colors = [
                    ['rgba(255, 99, 132)'],
                    ['rgba(54, 162, 235)'],
                    ['rgba(255, 206, 86)'],
                    ['rgba(75, 192, 192)'],
                    ['rgba(153, 102, 255)'],
                    ['rgba(175, 238, 238)'],
                    ['rgba(178, 145, 47)'],
                    ['rgba(127,255,0)'],
                    ['rgba(255,99,71)'],
                    ['rgba(77, 77, 77)']
                ];
                var i = 0;
                
                Array.from(labelmap.keys()).forEach(function(label) {
                    summaryset.push({
                        label: label,
                        backgroundColor: colors[i][0],
                        borderColor: 'grey',
                        borderWidth: 0.5,
                        data: [Array.from(labelmap.get(label).values()).reduce((a, b) => a + b, 0)]
                    });
                    i++;
                    
                    var labels = Array.from(labelmap.get(label).keys()).slice(0, 10);               
                    var data = Array.from(labelmap.get(label).values()).slice(0, 10);              
                    new Chart(label.replace(" ", "") + "Chart", {
                        type: 'pie',
                        data: {
                            labels: labels,
                            datasets: [{
                                //label: 'Units sold',
                                data: data,
                                borderWidth: 1,
                                backgroundColor: [
                                    colors[0][0],
                                    colors[1][0],
                                    colors[2][0],
                                    colors[3][0],
                                    colors[4][0],
                                    colors[5][0],
                                    colors[6][0],
                                    colors[7][0],
                                    colors[8][0],
                                    colors[9][0],
                                ]
                            }]
                        },
                        options: {
                            title: {
                                display: true,
                                text: 'Top 10 ' + label + ' Breakdown'
                            },
                            legend: {
                                position: 'right'
                            }
                        }
                    });
                });
                               
                var summarychart = new Chart("SummaryChart", {
                    type: 'bar',
                    data: {
                        labels: ["Total units sold"],
                        datasets: summaryset
                    },
                    options: {
                        title: {
                            display: true,
                            text: 'Sales Summary'
                        },
                        legend: {
                            position: 'bottom'
                        },
                        scales: {
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true
                                }
                            }]
                        }
                    }
                });
                var schart = document.getElementById("SummaryChart");
                schart.onclick = function (evt) {
                    var activePoint = summarychart.getElementAtEvent(evt)[0];
                    var data = activePoint._chart.data;
                    var datasetIndex = activePoint._datasetIndex;
                    var label = data.datasets[datasetIndex].label;
                    
                    var topcharts = document.getElementsByClassName("top10");
                    
                    for (var i = 0; i < topcharts.length; i++) {
                        topcharts[i].style.display = "none";
                    }
                    
                    var elem = document.getElementById(label.replace(" ", ""));
                    elem.style.display = 'block';
                    
                };

            });
        </script>
    </body>
</html>
